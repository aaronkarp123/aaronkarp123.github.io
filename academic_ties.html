<head>
  <style> body { margin: 0; } </style>

  <script src="https://unpkg.com/force-graph/dist/force-graph.min.js"></script>
  <script src="https://unpkg.com/force-graph/dist/d3-quadtree"></script>
  <script src="https://unpkg.com/force-graph/dist/d3-force"></script>
  <script type="text/javascript" src="autocomplete.js"></script>
  <script type="text/javascript" src="d3.min.js"></script>
  <link rel="stylesheet" href="searchStyle.css"/>

</head>

<body>
  <div id="searchbar" style="width:100%; height:0%; position: absolute;
    top: 40px;
    left: 5%;
    z-index: 100;"></div>
  <div id="formlink"  style="width:100%; height:5%; font-size: 15px; margin-left: 5%;position: absolute;
    top: 25px;
    left: 5%;
    z-index: 99;">This site needs your help! Want to add a node or a connection, or make a correction? Please use <a href="https://www.google.com" target="_blank">this link</a>.</div>

<div id="graph"></div>
  <div id="description" style="width:auto; max-width: 35%; height:auto; padding: 10px; box-shadow: rgba(50, 50, 93, 0.25) 0px 30px 60px -12px inset, rgba(0, 0, 0, 0.3) 0px 18px 36px -18px inset; display: none;">ASDASDDS</div>



<script>
  var Graph;
  var currentNode;
  var currentLink;
  var currentType;
  var num_anim_frames = 0;
  var max_anim_frames = 250;

  window.mobileCheck = function() {
  let check = false;
  (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
  return check;
};
  
  var anim_frames = 1000;

  if (mobileCheck()){
    anim_frames = 100;
  }

  fetch('https://raw.githubusercontent.com/aaronkarp123/aaronkarp123.github.io/master/Academic_Ties.json').then(res => res.json()).then(data => {
    const elem = document.getElementById('graph');

    for (let i = 0; i < data['nodes'].length; i++){
      let node = data['nodes'][i];
      if (node['Type'] == 'Educational Institution'){
        node['Value'] = 1.0;
      }
      else if (node['Type'] == 'Company'){
        node['Value'] = 1.0;
      }
      else{
        node['Value'] = 0.3;
      }
      currentNode = node;
    }

    currentLink = data['links'][0]

    Graph = ForceGraph()(elem)
      .graphData(data)
      .nodeLabel('Name')
      .nodeAutoColorBy('Type')
      .nodeVal('Value')
      .cooldownTicks(50) 
      .onBackgroundClick(clk=>{document.getElementById('description').style.display = 'none';})
      .linkDirectionalParticles(2)
      .linkDirectionalParticleWidth(1.4)
      .linkAutoColorBy(d => d.Type)
      .onNodeClick(node => {
        focus_on_node(node);
      })
      .onNodeDrag(node => {
        num_anim_frames = max_anim_frames;
      })
      .onLinkClick(link => {
        focus_on_link(link);
      })
      .onEngineStop(() => {Graph.zoomToFit(800, 50); Graph.cooldownTicks(300);})
      .onRenderFramePost(tck => {
        if (currentType == 0){
          var cur_coord = Graph.graph2ScreenCoords(currentNode.x, currentNode.y);
          if (document.getElementById('description').style.display != 'none' && num_anim_frames > 0){
            document.getElementById('description').style.left =  cur_coord['x'] - currentNode.Value*10.0;
            document.getElementById('description').style.top =  cur_coord['y'] - currentNode.Value*10.0;
            num_anim_frames -= 1;
          }
        }
        else{
          var cur_coord = Graph.graph2ScreenCoords(currentLink.source.x, currentLink.source.y);
          if (document.getElementById('description').style.display != 'none' && num_anim_frames > 0){
            document.getElementById('description').style.left =  cur_coord['x'];
            document.getElementById('description').style.top =  cur_coord['y'];
            num_anim_frames -= 1;
          }
        }
      })
      .linkCanvasObjectMode(() => 'after')
      .linkCanvasObject((link, ctx) => {
        const MAX_FONT_SIZE = 4;
        const LABEL_NODE_MARGIN = Graph.nodeRelSize() * 1.5;

        const start = link.source;
        const end = link.target;

        // ignore unbound links
        if (typeof start !== 'object' || typeof end !== 'object') return;

        // calculate label positioning
        const textPos = Object.assign(...['x', 'y'].map(c => ({
          [c]: start[c] + (end[c] - start[c]) / 2 // calc middle point
        })));

        const relLink = { x: end.x - start.x, y: end.y - start.y };

        const maxTextLength = Math.sqrt(Math.pow(relLink.x, 2) + Math.pow(relLink.y, 2)) - LABEL_NODE_MARGIN * 2;

        let textAngle = Math.atan2(relLink.y, relLink.x);
        // maintain label vertical orientation for legibility
        if (textAngle > Math.PI / 2) textAngle = -(Math.PI - textAngle);
        if (textAngle < -Math.PI / 2) textAngle = -(-Math.PI - textAngle);

        const label = `${link.Type}`;

        // estimate fontSize to fit in link length
        ctx.font = '1px Sans-Serif';
        const fontSize = Math.min(MAX_FONT_SIZE, maxTextLength / ctx.measureText(label).width);
        ctx.font = `${fontSize}px Sans-Serif`;
        const textWidth = ctx.measureText(label).width;
        const bckgDimensions = [textWidth, fontSize].map(n => n + fontSize * 0.2); // some padding

        // draw text label (with background rect)
        ctx.save();
        ctx.translate(textPos.x, textPos.y);
        ctx.rotate(textAngle);

        ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
        ctx.fillRect(- bckgDimensions[0] / 2, - bckgDimensions[1] / 2, ...bckgDimensions);

        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = 'darkgrey';
        ctx.fillText(label, 0, 0);
        ctx.restore();
      });

  });

  function focus_on_node(node){
    var node;
    var nodes = Graph.graphData()['nodes'];
    for (let i = 0; i < nodes.length; i++){
      if (nodes[i].id== node.id){
        node = nodes[i];
        break;
      }
    }

    Graph.centerAt(node.x, node.y, 1000);
    Graph.zoom(8, 1000);

    let desc = node.Description;
    if (desc != ''){
      desc += "<br>";
    }
    document.getElementById('description').innerHTML = "<b>" + node.Name + "</b><br>" + desc + "<a href='"+node.URL+"' target='_blank'>Reference Link</a><br>Information last updated: " + node['Last Updated'].split('T')[0];
    document.getElementById('description').style.display = 'block';
    document.getElementById('description').style.position = 'absolute';
    currentNode = node;
    currentType = 0;
    num_anim_frames = max_anim_frames;
  }

  function focus_on_link(link){
    // Center/zoom on node
    var midpoint = ([x1, y1], [x2, y2]) => [(x1 + x2) / 2, (y1 + y2) / 2];
    var pnt = midpoint([link.source.x, link.source.y], [link.target.x, link.target.y]);
    Graph.centerAt(pnt[0], pnt[1], 1000);
    Graph.zoom(8, 2000);
    let desc = link.Description;
    if (desc != ''){
      desc += "<br>";
    }
    document.getElementById('description').innerHTML = "<b>" + link['E 1'] + "</b>, " + link.Current + " " + link.Type + " at <b>"+ link['E 2'] +"</b><br>" + desc + "<a href='"+link.URL+"' target='_blank'>Reference Link</a><br>Information last updated: " + link['Last Updated'].split('T')[0];
    document.getElementById('description').style.display = 'block';
    document.getElementById('description').style.position = 'absolute';
    currentLink = link;
    currentType = 1;
    num_anim_frames = max_anim_frames;
  }

  var keys;
  d3.json("https://raw.githubusercontent.com/aaronkarp123/aaronkarp123.github.io/master/Academic_Ties.json",function (fdata) {
        keys=fdata['nodes'];
        start();
    });

  //Call back for when user selects an option
  function onSelect(d) {
      focus_on_node(d);
      //onsubmit="document.body.style.zoom='100%'";
  }

  //Setup and render the autocomplete
  function start() {
      var mc = autocomplete(document.getElementById('searchbar'))
              .keys(keys)
              .dataField('Name')
              .placeHolder("Search Orgs, People, or Institutions - Start typing here")
              .width(960)
              .height(500)
              .onSelected(onSelect)
              .render();
  }


  



</script>
</body>